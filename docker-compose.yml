services:
  api:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: server
    ports:                    # ← ДОБАВЬ ЭТО!
      - "8000:8000"
    command: ["uvicorn", "app:app", "--host", "0.0.0.0", "--port", "8000"]
    env_file:
      - backend/.env

  agent:
    build:
      context: ./backend
      dockerfile: Dockerfile.agent # отдельный Dockerfile для агента
    container_name: livekit-agent
    env_file:
      - backend/.env
    ports:
      - "4000:4000"  # LiveKit Agent порт
    restart: unless-stopped
    depends_on:
      - api
    deploy:
      resources:
        limits:
          memory: 16G     # ← 4GB для Silero + LiveKit!
          cpus: '4.0'     # 2 CPU
        reservations:
          memory: 4G
    environment:
      - LIVEKIT_AGENT_MAX_MEMORY_MB=16384  # убираеdcoт warning
      - TORCH_BACKEND=none                # убирает NNPACK spam
    volumes:
      - ./backend/logs:/agent/logs
        
  trunk:
    build:
      context: ./backend
      dockerfile: Dockerfile.trunk
    container_name: provisioning  # ← Лучше provisioning вместо server
    ports:
      - "6000:6000"              # ✅ Уже есть!
    env_file:
      - backend/.env
    command: ["python", "main.py"]  # ← КРИТИЧНО! Без этого не запустится
    restart: unless-stopped       # ← Добавь для автозапуска
